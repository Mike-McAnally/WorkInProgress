<html>
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta http-equiv="content-type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width,shrink-to-fit=no,user-scalable=no,maximum-scale=1,minimum-scale=1">
    <title>Islands</title>
    <meta name="description" content="Islands WebVR-Lab environment for experimenting with networked-aframe."></meta>
    <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0, shrink-to-fit=no">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="gray-translucent" />
<!-- A-frame component libraries -->
    <script src="js/aframe-v0.9.2.min.js"></script>
    <script src="js/aframe-environment-component.js"></script>
    <script src="js/aframe-extras.min.js"></script>
    <script src="js/aframe-teleport-controls.min.js"></script>
    <script src="js/aframe-text-geometry-component.min.js"></script>
    <!-- extra stuff for later on... you can look them up on github  -->
    <script src="js/aframe-alongpath-component.min.js"></script>
    <script src="js/aframe-curve-component.min.js"></script>
    <script src="js/aframe-mouse-cursor-component.min.js"></script>
    <script src="js/aframe-multisrc-component.js"></script>
    <script src="js/aframe-particle-system-component.min.js"></script>

    <!-- Libs required for NAF (NAF needs to be globally accessible) -->
    <script>window.NAF || document.write('<script src="js/networked-aframe.min.js">\x3C/script>')</script>
    <script src="js/socket.io.min.js"></script>
    <script src="js/easyrtc.js"></script>
<!-- see a-frame scene below https://github.com/donmccurdy/aframe-inspector-plugin-recast
    <script src="https://recast-api.donmccurdy.com/aframe-inspector-plugin-recast.js"></script>
-->

        <script type="text/javascript">
      // Component to do on click.
      AFRAME.registerComponent('click-listener', {
        init: function () {
            this.el.addEventListener('click', function (evt) {
                // remove clicked object from view
                this.setAttribute('visible', false);
                //slower...
                //document.getElementById('cube').setAttribute('visible', false);
            });
        }
      });
      function doSomethingElse() {
        //window.location.href="https://rocketvirtual.com";
        document.getElementById('sphere').setAttribute('color', 'purple');
      }
      //   audio problem (and it is...) https://stackoverflow.com/questions/47921013/play-sound-on-click-in-a-frame?answertab=active#tab-top
      AFRAME.registerComponent('audiohandler', {
        init:function() {
            let playing = false;
            let audio = document.querySelector("#playAudio");
            this.el.addEventListener('click', () => {
                if(!playing) {
                    audio.play();
                } else {
                    audio.pause();
                    audio.currentTime = 0;
                }
                playing = !playing;
            });
        }
      })
      function GoNode(nodeURL) {
        window.location.href = "/" + nodeURL;
      }
  </script>


  </head>
  <body>
    <button id="playButton" type="button">Play Music</button>
    <!-- I like the sound of this fun, joyful Carnival Banna tune for game: this "Royalty Purchase" for 10,000 downloads -->
<!--    <audio id="playAudio" autoplay loop>
        <source src="https://rocketvirtual.com/webvr/mp3/Carnival_Banana.mp3" type="audio/mpeg">    
    </audio> -->

<!-- used for creating Navmesh... see javascript component above <a-scene inspector-plugin-recast>  https://github.com/donmccurdy/aframe-inspector-plugin-recast -->

  <a-scene networked-scene="room: Islands; debug: true; adapter: easyrtc; audio: true;" background="color: #FAFAFA"> 

      <a-assets>
        <img crossorigin="anonymous" id="VRnode_APortal" src="img/Portal_Beach.png">
        <img crossorigin="anonymous" src="img/play2.png" id="play" >
        <a-asset-item crossorigin="anonymous" id="Islands" src="/assets/gltf/Islands.glb"></a-asset-item>
        <a-asset-item crossorigin="anonymous" id="Palm" src="/assets/gltf/palm.glb"></a-asset-item>
        <a-asset-item id="Building" src="/assets/gltf/ThinWallRmFinal.glb" nav-agent="speed: 1.5; active: true"></a-asset-item>

        <a-asset-item id="SwivelChair" src="/assets/gltf/chair4.glb"></a-asset-item>
        <a-asset-item id="Table1" src="/assets/gltf/Table_curved_legs.glb"></a-asset-item>
        <a-asset-item id="Shelf1" src="/assets/gltf/Pigeon_hole_shelf.glb"></a-asset-item>
        <a-asset-item id="Computer_Desk1" src="/assets/gltf/computer_Desk.glb"></a-asset-item>
        <a-asset-item id="Shelf2" src="/assets/gltf/shelf3.glb"></a-asset-item>
        <a-asset-item id="Shelf3" src="/assets/gltf/shelf4.glb"></a-asset-item>
        
        <template id="avatar-template">
          <a-entity></a-entity>
        </template>
        
        <template id="head-template">
          <a-entity class="cam" obj-model="obj: url(assets/head.obj); mtl: url(assets/head.mtl)"></a-entity>
        </template>
        
        <template id="hand-template">
          <a-entity class="leftController">
            <a-box class="box" scale="0.1 0.1 0.1"></a-box>
          </a-entity>
        </template>
      </a-assets>

      <a-entity id="mouseCursor" cursor="rayOrigin: mouse"></a-entity>

      <a-entity id="NodeName" position="36.543 4.316 -19.806" rotation="0.000 -107.878 0.000" scale="1 1 1" text-geometry="value: Node - Islands.; opacity: .5; size: .175; font: https://rawgit.com/mrdoob/three.js/dev/examples/fonts/optimer_bold.typeface.json"></a-entity>

      <!-- nav-mesh   -->
      <a-entity id="navmesh-Islands2" gltf-model="/assets/gltf/navmesh_final.gltf" position="0 -0.018 0" scale="" visible="false" nav-mesh=""></a-entity>

      <!-- Basic movement, selection and teleport -->
      <a-entity id="avatar" networked="template:#avatar-template;attachTemplateToLocal:false;"
        movement-controls="constrainToNavMesh: true;" position="32.045 2.958 -19.244" rotation="0 74.439 0">
        <a-entity class="cam" networked="template:#head-template;attachTemplateToLocal:false;" camera="active: true"
          position="0 1.6 0" rotation="0 0 0" look-controls></a-entity>
        <a-entity class="leftController" networked="template:#leftController-template;attachTemplateToLocal:false;"
          hand-controls="left" tracked-controls vive-controls="hand: left" oculus-touch-controls="hand: left"
          windows-motion-controls="hand: left"
          teleport-controls="cameraRig: #avatar; button: trigger; curveShootingSpeed: 11; collisionEntities: #navmesh-Islands2;"
          visible="true" scale="0.8 0.8 0.8"></a-entity>
        <a-entity class="rightController" networked="template:#rightController-template;attachTemplateToLocal:false;"
          hand-controls="right" tracked-controls vive-controls="hand: right" oculus-touch-controls="hand: right"
          windows-motion-controls="hand: right" laser-controls
          raycaster="showLine: true; far: 20; interval: 0; objects: .clickable, a-link;" line="color: lawngreen; opacity: 0.5"
          visible="true" scale="0.8 0.8 0.8"></a-entity>
      </a-entity>     

      <!-- Island -->
      <a-entity id="Mind_Palace_Islands" gltf-model="#Islands" position="0 -2.713 0" scale="75 75 75" shadow></a-entity>

      <a-entity id="Meeting_Structure" gltf-model="#Building" position="44.698 2.155 -25.119" rotation="0 163.797 0" scale="0.02 0.02 0.02" shadow></a-entity>

      <a-entity id="Islands_small_map" gltf-model="#Islands" position="30.536 3.371 -20.312" rotation="0 -5.872 0" scale="0.30 0.30 0.30" shadow visible=""></a-entity>

      <!-- Office Furniture -->
      <a-entity id="Office_Swivel_Chair1" gltf-model="#SwivelChair" position="27.561 3.807 -19.229" rotation="0 -5.872 0" scale="0.014 0.014 0.014" shadow visible=""></a-entity>
      <a-entity id="Office_Swivel_Chair2" gltf-model="#SwivelChair" position="30.479 3.807 -18.928" rotation="0 178.533 0" scale="0.014 0.014 0.014" shadow visible=""></a-entity>

      <a-entity id="Table_curved_legs" gltf-model="#Table1" position="30.574 2.408 -20.312" rotation="0 -5.872 0" scale="0.0012 .0012 .0012" shadow visible=""></a-entity>

      <a-entity id="Computer_Desk" gltf-model="#Computer_Desk1" position="27.625 2.407 -19.311" rotation="0 165.888 0" scale="0.013 0.013 0.013" shadow visible=""></a-entity>

      <a-entity id="Pigeon_hole_shelf" gltf-model="#Shelf1" position="30.355 2.413 -17.485" rotation="0 167.841 0" scale="0.0125 0.0125 0.0125" shadow visible=""></a-entity>

      <a-entity id="Shelf2" gltf-model="#Shelf2" position="31.262 2.408 -22.027" rotation="0 -22.006 0" scale="1.100 1.100 1.100" shadow  visible=""></a-entity>

      <a-entity id="Shelf3" gltf-model="#Shelf3" position="29.432 2.408 -22.818" rotation="0 -20.376 0" scale="0.003 0.003 0.003" shadow visible=""></a-entity>

      
      <!-- PDF reader component -->
      <a-entity
        id="pdf-wrapper"
        position="32.010 3.952 -21.528"
        rotation="0 -14.790 0"
      >
        <!-- back arrow -->
        <a-image
          class="clickable"
          id="prev-page"
          width="0.15"
          height="0.15"
          src="#play"
          position="-0.3 0 0.01"
          rotation="0 0 180"
          material="color: #eee"
        ></a-image>

        <!-- forward arrow -->
        <a-image
          id="next-page"
          class="clickable"
          width="0.15"
          height="0.15"
          src="#play"
          position="0.3 0 0.01"
          material="color: #eee"
        ></a-image>
      </a-entity>

      <!-- Palm Trees  -->
      <a-entity id="Palm_Tree1" gltf-model="#Palm" position="18.701 2.328 -41.067" rotation="0 0 0" scale=".002 .003 .002" shadow></a-entity>
      <a-entity id="Palm_Tree2" gltf-model="#Palm" position="-15.474 2.595 -20.555" rotation="-3.741 111.923 9.209" scale=".002 .003 .002" shadow></a-entity>
      <a-entity id="Palm_Tree3" gltf-model="#Palm" position="-34.756 2.864 -35.312" rotation="-3.285 61.159 11.798" scale=".002 .002 .002" shadow></a-entity>
      <a-entity id="Palm_Tree4" gltf-model="#Palm" position="35.161 2.186 -17.846" rotation="0 14.838 0" scale=".002 .003 .002" shadow></a-entity>
      <a-entity id="Palm_Tree5" gltf-model="#Palm" position="7.389 2.256 -59.464" rotation="6.168 124.621 6.056" scale=".002 .003 .002" shadow></a-entity>  
      <a-entity id="Palm_Tree6" gltf-model="#Palm" position="-13.021 2.903 -18.189" rotation="0 -147.427 0" scale=".002 .003 .002" shadow></a-entity>
      <a-entity id="Palm_Tree7" gltf-model="#Palm" position="-30.438 2.313 -44.343" rotation="10.420 -146.811 6.747" scale=".002 .002 .002" shadow></a-entity>

      <!-- Ocean -->
      <a-ocean position="0 0.986 0" scale="3 3 3" width="50" depth="50" opacity=".75" ocean="density: 45; amplitude: -0.1; speed: 0.75; speedVariance: 0.1"></a-ocean>

      <!-- Sky -->
      <a-sky src="/img/pinksky.png" rotation="0 0 0"></a-sky> 

      <!-- Light 1 -->
      <a-light type="ambient" position="-83.68534 30.81376 -20.81553" color="white" light="type: hemisphere; intensity: 0.35" visible=""></a-light>

      <!-- Light 2 -->
      <a-light type="ambient" position="55.21461 30.81376 -26.72374" color="white" light="type: hemisphere; intensity: 0.25" visible=""></a-light>

      <!-- Shadow Camera -->
      <a-entity class="environment" position="-48.69131 31.09116 -7.77003" light="intensity: 0.85; castShadow: true; shadowCameraLeft: -95; shadowCameraBottom: -95; shadowCameraRight: 95; shadowCameraTop: 95; shadowRadius: 50; shadowCameraFar: 100; shadowCameraNear: 1" visible=""></a-entity>

      <a-entity visible="" light="type: point; castShadow: true; intensity: 0.25;" position="23.316 34.056 -21.984" rotation="-21.967 168.02 -20.169"></a-entity>

      <a-link href="/VRnodeLabelA5.html" color="white" image="#VRnode_APortal" visible="true" title="Beach" on="click" position="33.170 4.483 -45.321" rotation="-0.164 -23.914 0" scale="2 2 2" material="shader: portal; borderEnabled: 1; pano: #VRnode_APortal; side: back"></a-link>

    </a-scene>

    <script>
      /**
       * NAF Setup
       */
      NAF.schemas.add({
        template: '#avatar-template',
        components: [
          'position',
          'rotation',
        ]
      });
      NAF.schemas.add({
        template: '#head-template',
        components: [
          'position',
          'rotation',
        ]
      });
      NAF.schemas.add({
        template: '#hand-template',
        components: [
          'position',
          'rotation',
        ]
      });
      function onConnect() {
        console.log("connected to a room!");
      }

      // PDF controls
      const fileName = 'vr_dev';
      const pdfWrapperEl = document.querySelector('#pdf-wrapper');
      let curPage = 1;

      function getPage(page) {
          const fetchPromise = fetch(`/${fileName}.pdf/${page}`);
          fetchPromise.then(response => {
          return response.json();
          }).then(data => {
              if(data.path && data.path.length > 0) {
                  const prevPdf = document.querySelector(`#${fileName}_PDF`);
                  if (prevPdf) {
                      prevPdf.parentNode.removeChild(prevPdf);
                  }

                  const pdfEl = document.createElement('a-entity');
                  pdfEl.id = `${fileName}_PDF`;
                  pdfEl.setAttribute('geometry', 'primitive: plane; width: 0.42; height: 0.594')
                  pdfEl.setAttribute('material', `color: #fff; side: double; src: ${data.path}`)
                  pdfWrapperEl.appendChild(pdfEl);
              }
          });
      }

      async function getNextPage() {
          await getPage(++curPage);
      }
      
      async function getPrevPage() {
          await getPage(--curPage);
      }

      // Add event listeners for buttons
      document.querySelector('#prev-page').addEventListener('click', function () {
          getPrevPage();
      });

      document.querySelector('#next-page').addEventListener('click', function () {
          getNextPage();
      });

      // start from page 0
      getPage(curPage);
    </script>
  </body>
</html>
